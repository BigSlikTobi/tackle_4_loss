# TODOs: Known Issues and Required Clean_ups

## Table of Contents
- [Task: Create Global Language Selection Control for Adaptive UI](#task-create-global-language-selection-control-for-adaptive-ui)
- [Task: Resolve Persistent 404 Asset Loading Error on Web/Desktop](#task-resolve-persistent-404-asset-loading-error-on-webdesktop)
- [Task: Implement Pagination for Team-Specific Article List](#task-implement-pagination-for-team-specific-article-list)
- [Task: Refactor Hardcoded Team ID Mapping in RealtimeService](#task-refactor-hardcoded-team-id-mapping-in-realtimeservice)

## Task: Create Global Language Selection Control for Adaptive UI

**Problem:**
The app uses an adaptive navigation system (`MainNavigationWrapper`):
- Mobile uses `BottomNavigationBar`.
- Desktop/Tablet uses a `Drawer` accessed via the `AppBar`.
The language selection UI (EN/DE RadioListTiles) was implemented *only* within the `Drawer`, making it unavailable on mobile. We need a consistent way for users on all platforms to access and change the language preference managed by `localeNotifierProvider`.

**Goal:**
Implement a user interface element for language selection that is:
1.  **Accessible** on both mobile and desktop layouts.
2.  **Consistent** in function.
3.  **Integrated** naturally into the UI patterns for each layout.

**Possible Approaches (Consider these or propose others):**
*   **Option A (Global Action):** Move the language picker back to the `GlobalAppBar`'s `actions` list (using a `PopupMenuButton` or similar) so it's always visible in the top bar.
*   **Option B (Conditional UI):** Keep the language picker in the `Drawer` for desktop, but add a dedicated language setting option within one of the mobile `BottomNavigationBar` tabs (e.g., inside the "More" screen).
*   **Option C (Dedicated Settings Screen):** Create a dedicated "Settings" screen accessible from both the `Drawer` (desktop) and the `BottomNavigationBar` (mobile, likely via the "More" tab) where language selection resides.

## Task: Resolve Persistent 404 Asset Loading Error on Web/Desktop

**Problem:**
When running the application, particularly after selecting a "My Team" preference which triggers updates in the `TeamHuddleSection` and its child widgets (`UpcomingGamesCard`, `InjuryReportCard`), we consistently encounter 404 errors when trying to load team logo assets.

The error message typically looks like this:
`Error while trying to load an asset: Flutter Web engine failed to fetch "assets/assets/logos/some_team_name.png". HTTP request succeeded, but the server responded with HTTP status 404.`

The key issue is the duplicated path segment **`assets/assets/`**. This indicates that somewhere in the code, the 'assets/' prefix is being added incorrectly to the already correct path generated by the `getTeamLogoPath` helper function (which returns 'assets/team_logos/some_team_name.png').

Despite previous attempts to fix direct `Image.asset()` calls in the relevant widgets (`TeamHuddleSection`, `UpcomingGamesCard`, `InjuryReportCard`, `TeamSelectionDropdown`), the issue persists, suggesting the problem might be more subtle or located elsewhere. The `PointerDeviceKind.trackpad` assertion error in the logs is likely unrelated but occurred concurrently.

**Goal:**
Identify and fix the root cause of the duplicated `assets/assets/` path when loading team logo images. Ensure that `Image.asset` consistently receives the correct path (e.g., `assets/team_logos/chicago_bears.png`) and that logos load correctly across all relevant widgets and application states, especially after selecting a team preference.

**Possible Areas to Investigate:**
*   **Re-verify `Image.asset` Calls:** Meticulously re-examine every single `Image.asset()` call that uses the `getTeamLogoPath` function in the following files (and any others potentially added):
    *   `lib/features/my_team/ui/widgets/team_huddle_section.dart`
    *   `lib/features/my_team/ui/widgets/upcoming_games_card.dart`
    *   `lib/features/my_team/ui/widgets/injury_report_card.dart`
    *   `lib/features/my_team/ui/widgets/team_selection_dropdown.dart`
    Ensure there's no string concatenation adding an extra `assets/`.
*   **`getTeamLogoPath` Function:** Double-check the return value of `getTeamLogoPath` in `lib/core/constants/team_constants.dart` to be absolutely certain it returns the correct format (`assets/team_logos/...`).
*   **State Management Interactions:** Could a Riverpod provider or state update interaction somehow be modifying or incorrectly passing the path string? (Less likely, but possible).
*   **Build/Cache Issues:** Although `flutter clean` was likely tried, consider if there's a more persistent web build cache issue.
*   **Underlying Widget Issues:** Is there any custom widget wrapping `Image.asset` that might be interfering with the path?

**Acceptance Criteria:**
*   Selecting a team via the "My Team" feature (or dropdown) correctly displays the team's logo in the `TeamHuddleSection`, `UpcomingGamesCard`, and `InjuryReportCard` without any 404 errors in the console.
*   The path used to load the asset in the browser's network inspector (or Flutter logs) is correctly formatted (e.g., `assets/team_logos/some_team_name.png`).
*   The fix does not introduce regressions in other parts of the application.

## Task: Implement Pagination for Team-Specific Article List

**Problem:**
The `TeamArticleList` widget (used on the "My Team" screen) currently fetches only the *first page* of articles for the selected team using a `FutureBuilder` and the `NewsFeedService.getArticlePreviews` method. It does not handle loading subsequent pages of articles if more exist for that team, nor does it provide a mechanism for infinite scrolling. Users can only see the initial batch of articles returned.

**Goal:**
Refactor `TeamArticleList` to support pagination, allowing users to continuously load more articles for their selected team as they scroll down the list. The implementation should efficiently fetch data page by page using the cursor returned by the `articlePreviews` Edge Function.

**Possible Approaches & Considerations:**
*   **Refactor to `ConsumerStatefulWidget`:** The widget needs to manage a `ScrollController` to detect when the user scrolls near the bottom and maintain the list of loaded articles and the `nextCursor` state.
*   **Use Riverpod (Recommended):** Instead of managing state locally within the widget, create a dedicated Riverpod provider, likely an `AsyncNotifierProvider.family`, to handle the paginated state specifically for a given `teamId`.
    *   **Provider Definition:** Define `teamArticlesProvider = AsyncNotifierProvider.family<TeamArticlesNotifier, List<ArticlePreview>, String>(...)`. The family argument will be the `teamId`.
    *   **Notifier Logic (`TeamArticlesNotifier`):**
        *   The `build(String teamId)` method would perform the initial fetch using `NewsFeedService.getArticlePreviews(teamId: teamId)`.
        *   Store the fetched articles, the `nextCursor`, and loading states internally.
        *   Implement a `fetchNextPage()` method similar to the one in `PaginatedArticlesNotifier` but using the stored `teamId` and cursor for subsequent calls to `getArticlePreviews`.
    *   **UI (`TeamArticleList` becomes `ConsumerWidget`):**
        *   Watch the new provider: `ref.watch(teamArticlesProvider(teamId))`.
        *   Use the `AsyncValue` state (`.when(...)`) to display loading, error, and data states.
        *   Attach a `ScrollController` to the `ListView.builder`.
        *   In the scroll listener (`_onScroll`), call `ref.read(teamArticlesProvider(teamId).notifier).fetchNextPage()`.
        *   In the `ListView.builder`, check if more data is being loaded (`teamArticlesValue is AsyncLoading && teamArticlesValue.hasValue`) and display a loading indicator at the end of the list.
*   **ScrollController:** Add a `ScrollController` and attach it to the `ListView.builder`. Add a listener to detect when the user is near the bottom (`scrollController.position.pixels >= scrollController.position.maxScrollExtent - threshold`).
*   **Loading Indicator:** Append a `LoadingIndicator` widget to the end of the list while `fetchNextPage()` is executing.
*   **Error Handling:** Ensure errors during subsequent page fetches are handled gracefully (e.g., show a message, stop trying to load more).

**Acceptance Criteria:**
*   When viewing the "My Team" screen with a selected team, the initial list of articles loads.
*   Scrolling down the list triggers fetching of the next page of articles for that specific team when the user nears the bottom.
*   New articles are appended seamlessly to the existing list.
*   A loading indicator is shown at the bottom while fetching subsequent pages.
*   Pagination stops correctly when the backend indicates no more articles are available (no `nextCursor`).
*   The implementation uses Riverpod (`AsyncNotifierProvider.family` recommended) for managing the paginated state.

## Task: Refactor Hardcoded Team ID Mapping in RealtimeService

**Problem:**
The `RealtimeService` (`lib/core/services/realtime_service.dart`) currently uses a hardcoded `Map<String, int> teamAbbreviationToNumericId` to convert the user's selected team abbreviation (stored in preferences) to the numeric ID used in the `NewsArticles` table's `team` foreign key column. This mapping needs to be manually updated whenever team IDs change or new teams are added in the backend database, making it brittle and error-prone.

**Goal:**
Replace the hardcoded map with a dynamic and robust solution for mapping team abbreviations to their corresponding numeric IDs within the `RealtimeService`.

**Possible Approaches & Considerations:**
*   **Fetch from Database (Recommended):**
    *   Create a simple `TeamService` or add a method to an existing service to fetch all teams (or at least `id` and `abbreviation`) from the `Teams` table in Supabase.
    *   Modify `RealtimeService` or a dedicated provider to fetch this data once (e.g., during app startup or when the `RealtimeService` is initialized).
    *   Store the fetched mapping in memory (e.g., within the `RealtimeService` or a Riverpod provider state) for quick lookups in the `_handleNewsInsert` method.
    *   Consider caching this mapping in `shared_preferences` to avoid fetching on every app start, with a mechanism to refresh it periodically or on demand.
*   **Centralized Constant:** If fetching is deemed overkill (e.g., team IDs are extremely stable), move the mapping to `lib/core/constants/team_constants.dart` to keep it alongside the other team maps, but this still requires manual updates. Fetching is generally preferred for maintainability.

**Acceptance Criteria:**
*   The hardcoded `teamAbbreviationToNumericId` map is removed from `RealtimeService`.
*   The `RealtimeService` correctly maps the user's selected team abbreviation to the numeric team ID using data fetched from the backend (or a centrally managed source).
*   The real-time detection logic continues to function correctly, identifying relevant team-specific articles based on the dynamically obtained mapping.
*   The solution is reasonably efficient (e.g., avoids fetching the mapping on every single real-time event).